📘 発注仕様書,,,,,
1. 文書情報,,,,,
作成日：2026年1月29日,,,,,
2. 概要,,,,,
　受注メールを自動で読み取り、スクレイピングで判明した在庫が有る仕入先に割当て、管理することで速やかな仕入れ業務を実現する。,,,,,
3. 機能仕様,,,,,
3.1 機能一覧,,,,,
　(１)WEB(google driveかon-drive）での閲覧・チェック機能,,,,,
　(２)メール解析 → Excel自動連携,,,,,
　(３)在庫スクレイピング（複数サイト対応）,,,,,
　(４)保留・判定ロジック(例1〜4含む）,,,,,
　(５)実店舗メール生成,,,,,
　(６)管理画面２種(処理台帳/仕入台帳)とコントロールパネル（設定変更機能）１種の作成,,,,,
3.2 各機能の詳細仕様,,,,,
3.2.(1)メール解析 → Excel自動連携,,,,,
" 　・目的：(outlook想定)メール受信後,台帳(処理台帳)に登録",,,,,
 　・処理概要：メール記載の受注情報から商品コードを読み取る(指定文字より前の１３or５桁の数字),,,,,
 　・例外処理：読み取り不可の文字の場合、読み取り不能として台帳に表示,,,,,
 　・ 画面仕様：発注仕様書記載,,,,,
3.2.(2)在庫スクレイピング（複数サイト対応）,,,,,
 　・目的：メール記載の記載商品コードにて最新在庫情報をスクレイピング 　,,,,,
 　・＜スクレイピング先URL作成２方式＞（スクレイピング先に飛ぶ際のURLの決定方法）,,,,,
　　　①JAN / ISBN をURL末尾に組み込む方式,,,,,
　　　②CSV参照方式（コード → URL直接紐付け）,,,,,
　　　　＊CSVに該当コードが存在しない場合、「在庫無し扱い（商品ページ無し）」と判定し処理台帳上に表示。,,,,,
　　　　＊案件（設定）単位でのモード切替,,,,,
 　・＜例外機能＞,,,,,
　　　手持ち在庫がある商品のスクレイピング除外機能,,,,,
　　　CSV形式で商品CDと数量を読み込み、スクレイピング対象から除外した上で別枠で表示する設計。,,,,,
　　・＜処理概要＞,,,,,
　　　①スクレイピングは仕様変更やHTML変更に強い構造で抜本修正なしに設定画面から即座に再設定できる設計であること。,,,,,
　　　②ブラウザ上の全HTMLを読み取り、列ごとにパターン属性を付与しパターンを保存。HTMLの変更で列ごとに,,,,,
　　　　情報は変わってもはパターン属性を列ごとに変更することで変化に対応,,,,,
　　　　＊但し丸善ジュンク堂書店-店頭在庫情報だけは位置の特定が必要の可能性あり。,,,,,
　　・XPathやセレクタの多段階フォールバック機構を搭載。,,,,,【製作用属性パターンは発生者側で用意】
　　　＊これにより部分的なHTML変更が発生してもスクレイピング停止のリスクを最小化。,,,,,
　　　自動発注ページ仕様が大きく変更される場合でも、抜本的な修正は不要で、設定画面から即座に対応可能。,,,,,
＜対象サイト＞,,,,,
(EC)ヨドバシカメラ,保留機能,,,,
(EC)楽天ブックス,保留機能,,,,
(EC)紀伊国屋書店,保留機能,,,,
(EC)e-hon,保留機能,,,,
(EC)丸善ジュンク堂書店-web,保留機能,,,,
(EC)日本の古本屋,保留機能,,,,
(店頭)丸善ジュンク堂書店_各店頭在庫,保留、メール送信機能,,,,
(店頭)紀伊国屋書店_各店頭在庫,保留機能,,,,
(店頭)三省堂書店_各店頭在庫,保留機能,,,,
3.2.(3)保留・判定ロジック(例1〜4含む）,,,,,
<目的＞　CP：コントロールパネル,,,,,
"・在庫情報で以下の４つの判断(仕入前台帳,仕入後台帳) 　",,,,,
　(1)在庫があるECサイトでCP設定の優先順位に従い、設定合計金額まで台帳上で注文を保留【最優先】,,,,,
　(2)ECサイトに在庫が無く、在庫がある店頭在庫サイトで、CP設定優先順位に従い、設定合計金額まで保留先別に台帳上で保留。 　,,,,,
　(3)(2)到達後特定の実店舗は自動発注メールを送信。その他の店舗は手動で電話で連絡する。,,,,,
　(4)EC及び店頭在庫が無い場合、処理台帳で「在庫無し扱い（在庫無し）」と判定し処理台帳上に表示。,,,,,
<処理概要：>・ロジック自動化,,,,,
　保留中金額： 台帳にリアルタイム計算列を持たせる、Excel連携部分は当方で構築,,,,,
　在庫状態： スクレイピング判定値を「数値化」して保持,,,,,
　例：在庫○＝1、取り寄せ×＝0,,,,,
　仕入先優先順位： コントロールパネルでユーザーが変更可能、 GUI上で自由に入れ替え,,,,,
　最低積み上げライン： 仕入先ごとに設定可能、 台帳 or 設定画面,,,,,
　日数経過： 初回保留日時を台帳保存 → 経過日数自動算出、 手動介入不要,,,,,
　上記の複合条件をもとに「優先順位演算 → 自動発注 or 保留」まで自動処理します。,,,,,
　在庫判定、優先順位は各サイトごとにコントロールパネルで設定　,,,,,
　＊優先順位について,,,,,
　原則：①在庫が有って保留金額が1円以上ある仕入先で金額が一番大きい順に振分,,,,,
　　　　②在庫が有って①該当の仕入先が無い場合はサイト・店舗間での優先順位に基づいて振分,,,,,
　　　　　【製作用の優先順位リストは発生者側で用意】　,,,,,
画面仕様：発注仕様書記載,,,,,
3.2.(4)自動発注（EC＋実店舗メール生成）,,,,,
目的：,,,,,
処理概要：,,,,,
＜注文保留の考え方(EC/店頭共通)＞ ＊別途資料あり,,,,,
優先第一位 ・保留中金額が最低積み上げライン未満/在庫が有る/その中で最小保留合計金額,,,,,
優先第二位 ・保留中金額が最低積み上げライン以上/在庫が有る/その中で最小保留合計金額,,,,,
　＊自動発注仕入れ先の場合は保留中金額が最低積み上げライン以上になった時点で,,,,,
　　自動発注若しくは自動メール送信処理,,,,,
優先第三位 ・在庫が有る/保留中金額が0(保留受注残がない)/仕入れ先間優先順位順,,,,,
例外処理：,,,,,
画面仕様：発注仕様書記載,,,,,
バッチ仕様（該当する場合）：,,,,,
3.2.(5)管理画面２種(処理台帳/仕入台帳)とコントロールパネル（設定変更機能）１種の作成,,,,,
＊5.1 画面一覧及び詳細にて定義,,,,,
４. 画面仕様,,,,,
4.1 画面一覧及び詳細,,,,,
・処理台帳（案件単位管理),,,,,
　①受信項目(メール解析結果の表示),,,,,
　   表示項目：宛名/受信日/送信元/管理番号/商品CD/記載品名/記載金額/状態表示,,,,,
　②最新在庫情報(スクレピング結果の表示),,,,,
　　表示項目：発注・保留予定仕入先/在庫無し,,,,,
　③処理結果(自動発注/店頭保留結果の表示),,,,,
　　表示項目：店舗名/発注・保留仕入先/保留開始日/発生先での品名/税込金額/状態表示/,,,,,
　＊手動で処理台帳から削除できること。,,,,,
・仕入台帳(仕入単位管理),,,,,
表示項目：店舗名/仕入NO(仕入毎)/仕入状態/保留金額合計,,,,,
　　　/最初の保留からの経過日数/保留件数/商品名/金額/経過日数/CD,,,,,
　【処理台帳及び仕入台帳案のブラッシュアップは発生者側で作業】,,,,,
・コントロールパネル,,,,,
　各機能別でコントロールパネルでの設定項目,,,,,
　NO1：メール処理の設定,,,,,
　・抽出キー(複数)の設定(指定指定文字前の文字or数字抽出),,,,,
　NO2：自家在庫照合の設定,,,,,
　・csvの読み込みのみ,,,,,
　NO3：スクレイピングの設定,,,,,
　・属性指定：抽出したHTMLに「在庫情報」のパターン属性を付与,,,,,
　・サイト別スクレイピング対象ON/OFF機能,,,,,
　NO4：在庫判定と振分処理の設定,,,,,
　・在庫表記の登録,,,,,
　・優先順位の登録,,,,,
　No5：店頭保留の設定,,,,,
　・(店頭サイトのみ)自動発注メールON/OFF機能,,,,,
　・保留条件の設定機能,,,,,
　　項目：保留上限金額/上限日数/制限単価(高額品の除外),,,,,
　その他,,,,,
　・処理履歴ダウンロード機能(日付範囲指定),,,,,
　・テスト検証機能（ダミー実行）,,,,,
　・実際の発注を行わずに全フローをシミュレート,,,,,
　・エラー再チェック機能,,,,,
5. 非機能要件,,,,,
<エラー対策>,,,,,
・エラー発生時は処理を中断し、ログを記録、必要に応じて手動で再実行。,,,,,
・台帳上保留の際、上限金額到達後に再スクレイピングを実施し在庫変動によるエラーを防止。,,,,,
その結果、在庫なしが判明した場合は保留在庫の中で在庫切れが生じた場合、その在庫切れの金額分マイナスして、その結果を表示し在庫切れの分を仕入先なしに分類。,,,,,
・トラブル切り分け用の管理画面を用意、読み取りエラーや在庫取得エラー、発注エラー、,,,,,
　ログインエラーなど、どの段階で問題が発生したか、どう対処すべきかが明確に把握可能であること。,,,,,
"・ダミー環境によるテスト検証機能搭載,回帰テストや操作確認を行える。",,,,,
＜操作性＞,,,,,
・直感的に操作できるダッシュボードを提供し、モバイルやクラウド環境からの閲覧・操作も可能。,,,,,
　複雑な操作はAPI的操作に置き換え、カート遷移を省略して数量反映から発注までをスムーズに行える。,,,,,
　さらに、仕入先ごとに最適化された発注スクリプトを切り替え可能で、即時発注、,,,,,
　メール発注、スケジュール自動発注など、柔軟な運用にも対応。,,,,,
・本体をローカルに設置する場合でも、Google DriveやOneDrive上の設定ファイルや,,,,,
　操作フラグを同期することで、別端末からの閲覧や制御が可能,,,,,
6.納品物,,,,,
・納品物：ソースコード、設計書、テスト仕様書、運用マニュアルを納品対象とすること,,,,,